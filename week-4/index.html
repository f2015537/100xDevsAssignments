<!DOCTYPE html>
<html>
  <head>
    <script>
      // let globalId = 1;
      let todoState = [];
      let oldTodoState = [];

      function createChild(title, description, id) {
        const child = document.createElement("div");
        const firstGrandParent = document.createElement("div");
        firstGrandParent.innerHTML = title;
        const secondGrandParent = document.createElement("div");
        secondGrandParent.innerHTML = description;
        const thirdGrandParent = document.createElement("br");
        child.appendChild(firstGrandParent);
        child.appendChild(secondGrandParent);
        child.appendChild(thirdGrandParent);
        child.setAttribute("id", id);
        return child;
      }

      function addTodoToDom(todo) {
        const parent = document.getElementById("todos");
        parent.appendChild(createChild(todo.title, todo.description, todo.id));
      }

      function removeTodoFromDom(todo) {
        const parent = document.getElementById("todos");
        const elementToDelete = document.getElementById(todo.id);
        parent.removeChild(elementToDelete);
      }

      function updateTodoInDom(todo) {
        const elementToUpdate = document.getElementById(todo.id);
        elementToUpdate.innerHTML = `<div>${todo.title}</div>
        <div>${todo.description}</div>
        <br></br>`;
      }

      function updateState(newTodos) {
        // calculate the diff b/w newTodos and oldTodos.
        // More specifically, find out what todos are -
        // 1. added
        // 2. deleted
        // 3. updated
        const added = [];
        const deleted = [];
        const updated = [];
        // calculate these 3 arrays

        // added todos, todos that were not in old state but are present in newTodos
        newTodos.forEach((newTodo) => {
          if (!oldTodoState.find((oldTodo) => oldTodo.id === newTodo.id)) {
            added.push(newTodo);
          }
        });

        // deleted todos, todos that were in old state but are not present in newTodos
        oldTodoState.forEach((oldTodo) => {
          if (!newTodos.find((newTodo) => oldTodo.id === newTodo.id)) {
            deleted.push(oldTodo);
          }
        });

        // call addTodo, removeTodo, updateTodo functions on each of the
        // elements
        // updated todos, todos that are present in both new and old state but differ either in title or description or both
        newTodos.forEach((newTodo) => {
          oldTodoState.forEach((oldTodo) => {
            if (
              oldTodo.id === newTodo.id &&
              (oldTodo.title !== newTodo.title ||
                oldTodo.description !== newTodo.description)
            ) {
              updated.push(newTodo);
            }
          });
        });
        console.log("Old state: ", oldTodoState);
        console.log("New state: ", newTodos);
        console.log("Added: ", added);
        console.log("Deleted: ", deleted);
        console.log("Updated", updated);
        console.log("---------");
        added.forEach((todo) => addTodoToDom(todo));
        updated.forEach((todo) => updateTodoInDom(todo));
        deleted.forEach((todo) => removeTodoFromDom(todo));
        // updated.forEach((todo) => updateTodoInDom(todo));
        // const parent = document.getElementById("todos");
        // parent.innerHTML = "";
        // newTodos.forEach((todo) => addTodoToDom(todo));
        oldTodoState = newTodos;
      }

      // function addTodo() {
      //   const title = document.getElementById("title").value;
      //   const description = document.getElementById("description").value;
      //   todoState.push({
      //     title: title,
      //     description: description,
      //     id: globalId++,
      //   })
      //   updateState(todoState);
      // }
      window.setInterval(async function () {
        const parent = document.getElementById("todos");
        const response = await fetch("http://localhost:3000/api/todos");
        const json = await response.json();
        updateState(json);
        // console.log(json);
      }, 3000);
    </script>
  </head>

  <body>
    <!-- <input type="text" id="title" placeholder="Todo title"></input> <br /><br /> -->
    <!-- <input type="text" id="description" placeholder="Todo description"></input> <br /><br /> -->
    <!-- <button onclick="addTodo()">Add todo</button> -->
    <br />
    <br />

    <div id="todos"></div>
  </body>
</html>
